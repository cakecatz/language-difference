<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8" />
  <title>Language Difference</title>
  <link rel="stylesheet" href="./css/kube.min.css" />
  <link rel="stylesheet" href="./css/common.css" />
  <link rel="stylesheet" href="./css/tomorrow-night-eighties.css" />
  <script src="//cdn.jsdelivr.net/velocity/1.2.1/velocity.min.js"></script>
</head>
<body>
  <nav class="navbar nav-fullwidth">
    <ul>
      <li><a href="#" style="font-size: 23px;">LangDiff</a></li>
      <li><a href="#">Edit</a><li>
    </ul>
  </nav>

  <div class="units-row code-panel">
    <div class="left-code unit-50 units-row units-split">
      <h3><span class="language-name"></span></h3>
      <div class="unit-10 number-column"></div>
      <div class="unit-90 code-column"></div>
    </div>

    <div class="right-code unit-50 units-row units-split">
      <h3><span class="language-name"></span></h3>
      <div class="unit-10 number-column"></div>
      <div class="unit-90 code-column"></div>
    </div>
  </div>

  <div id="language-selector">
    <span>Rust</span>
    <span>C</span>
    <span>C++</span>
    <span>C#</span>
    <span>D</span>
    <span>JavaScript</span>
    <span>Perl</span>
    <span>Ruby</span>
    <span>bash</span>
  </div>

  <script sec="./js/kube.min.js"></script>
  <script src="./js/bundle.js"></script>

  <script>
    var reqListener = function(lang, pos){
      return function() {
        var codeColumn = document.querySelector('.' + pos + '-code .code-column');
        var numberColumn = document.querySelector('.' + pos + '-code .number-column');

        while (codeColumn.firstChild) {
          codeColumn.removeChild(codeColumn.firstChild);
        }

        while (numberColumn.firstChild) {
          numberColumn.removeChild(numberColumn.firstChild);
        }

        var o = langDiff.translate( pos, lang, JSON.parse(this.responseText) );
        codeColumn.insertAdjacentHTML('beforeend', o.body );

        document.querySelector('.' + pos + '-code .number-column').
          insertAdjacentHTML('beforeend', o.numberBody);


        console.log(document.querySelector('#' + o.id));
        hljs.highlightBlock( document.querySelector('#' + o.id) );
        hljs.highlightBlock( document.querySelector('#' + o.id + '-number') );

        document.querySelector('.' + pos + '-code .language-name').textContent = lang;
        languSelectorEvent();
      }
    };

    var changeLang = function(lang, pos) {
      var req = new XMLHttpRequest();
      req.onload = reqListener(lang, pos);
      req.open("get", "/code/" + lang.toLowerCase() + ".json", true);
      req.setRequestHeader('Cache-Control', 'no-cache');
      req.send();
    };

  </script>
  <script>
    var languSelectorEvent = function() {
      var langNames = document.querySelectorAll('span.language-name');
      var langSelector = document.getElementById('language-selector');
      var langSelectorLabel = document.querySelectorAll('#language-selector span');

      for (var i=0;i < langNames.length;++i ) {
        langNames[i].onclick = function() {
          langSelector.style.display = 'initial';
          langSelector.style.left = this.getBoundingClientRect().left + 'px';
          langSelector.style.top = this.getBoundingClientRect().bottom + 'px';
          if (window.innerWidth / 2 > this.getBoundingClientRect().left) {
            langSelector.pos = 'left';
          } else {
            langSelector.pos = 'right';
          }
        };
      }

      for (var i=0;i < langSelectorLabel.length;++i ) {
        langSelectorLabel[i].onclick = function() {
          changeLang(this.textContent, this.parentNode.pos);
        };
      }

      langSelector.onclick = function() {
        this.style.display = 'none';
      };

    };
  </script>
  <script>
  // init
  (function(){
    changeLang('Rust', 'left');
    changeLang('C', 'right');
  })();
  </script>
</body>
</html>
